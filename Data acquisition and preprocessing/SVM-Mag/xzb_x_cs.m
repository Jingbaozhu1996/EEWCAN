%计算卓越周期，峰值位移，峰值速度，峰值加速度
%巴特沃斯滤波
function [Pv,Pa,IV2,Tva,cav,caa,DE]= xzb_x_cs(inputA,output2,dt)
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here
%inputA 输入加速度
%output2 P波到时
%dt 时间间隔
[m n]=size(inputA);%输入加速度的矩阵维度
for j=1:n
    t(j,1)=(j-1)*dt;
end
t4=3;%表示时间窗长度s
v=cumtrapz(t,inputA);%速度，这是对加速度求积分
d=cumtrapz(t,v);%位移，这是对速度求积分
%----------------4阶0.075HZ-3HZ带通滤波-----------------------------------------%
                                                      %滤波阶段
fmax=3;      fmin=0.075;
cutup=fmax/(1/(2*dt));
cutdown=fmin/(1/(2*dt));
wn=[cutdown, cutup]; 
[b,a]=butter(4,wn);                                               %4阶滤波
%----------------4阶0.075HZ-3HZ带通滤波-----------------------------------------%


% %----------------4阶0.075HZ高通滤波-----------------------------------------%
% Fs = 1/dt;
% fl= 0.075; % low cutoff frequency for highpass filter, depending on you
% ftype = 'high';
% f_order = 4;% order
% [b,a] = butter(f_order,fl/(Fs/2),ftype);% f_order order butterworth highpass filter     
% %----------------4阶0.075HZ高通滤波-----------------------------------------%

inputA1=filter(b,a,inputA);%滤波后的加速度

v=filter(b,a,v);%滤波后的速度
d=filter(b,a,d);%滤波后的位移
[~,q]=min(abs(t-output2));
% t1=output2:output2+3;
n1=find(t==t(q,1));%n1是P波到时的后一个点
% v1=v(n1:);
% d1=d(n1:);
% a1=inputA1(n1:n1+t4/0.01);
t2=0:dt:t4;

if n1+t4/dt<=n
    v1=v(n1:n1+t4/dt);%时间窗内的速度
    d1=d(n1:n1+t4/dt);%时间窗内的位移
    a1=inputA1(n1:n1+t4/dt);%时间窗内的加速度
    t3=output2:dt:(output2+t4);
    IV2=trapz(t3,v1.^2);%速度平方积分
else
    v1=v(n1:n);%时间窗内的速度
    d1=d(n1:n);%时间窗内的位移
    a1=inputA1(n1:n);%时间窗内的加速度 
    t2=0:dt:(n-n1)*dt;
    t3=output2:dt:(output2+(n-n1)*dt);
    IV2=trapz(t3,v1.^2);%速度平方积分
end

Pv=max(abs(v1));%P波到时后，时间窗内的峰值速度
Pa=max(abs(a1));%P波到时后，时间窗内的峰值加速度
Tva=2*pi*(Pv/Pa);%P波到时后，时间窗内的峰值比
%--------------计算速度平方积分IV2--------------------------%

%--------------计算速度平方积分IV2--------------------------%
%仅计算一个分量上的
cav=sum(abs(v1));%CAV累积绝对速度UD
caa=sum(abs(a1));%CAA累积绝对加速度UD
DI=log(abs(a1.*v1));
DE=max(DI);%累积能量变化率


end

